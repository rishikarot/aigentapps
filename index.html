<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ROBO-BIN Â· AigentApps</title>

  <!-- Core PWA hints -->
  <meta name="theme-color" content="#065f46" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ROBO-BIN" />
  <!-- iOS safe-area support (needed to fully hide Safari UI in standalone) -->
  <meta name="format-detection" content="telephone=no" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- Icons for iOS add-to-home-screen -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180.png" />
  <link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="/splash/iphone12-portrait.png" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <!-- Icons + QR -->
  <script src="https://unpkg.com/phosphor-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <style>
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f0fdf4; }
    .container-shadow { box-shadow: 0 10px 25px -3px rgba(34,197,94,.2), 0 4px 6px -2px rgba(34,197,94,.1); }
    .h-pay-button { height: 3.25rem; }
    /* Fill the screen in standalone, respect notches */
    .app-shell { min-height: 100dvh; padding-bottom: env(safe-area-inset-bottom); padding-top: env(safe-area-inset-top); }
  </style>
</head>
<body class="bg-gray-100 app-shell flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl container-shadow p-8 max-w-lg w-full flex flex-col gap-6">
    <h1 class="text-xl font-extrabold text-center text-green-800 drop-shadow-sm">ROBO-BIN ðŸŒ±</h1>

    <div id="inputSection" class="bg-emerald-50 rounded-xl p-6 space-y-4">
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <div class="flex-1">
          <label for="rateInput" class="text-emerald-800 font-medium whitespace-nowrap block mb-1">Rate per KG (â‚¹):</label>
          <input type="number" id="rateInput" placeholder="Default: 7" class="p-3 border border-emerald-300 rounded-lg w-full focus:ring-emerald-500 focus:border-emerald-500 transition duration-200" inputmode="decimal" />
          <p id="rateError" class="text-red-500 text-sm italic hidden mt-1">Please enter a valid rate.</p>
        </div>
        <div class="flex-1">
          <label for="weightInput" class="text-emerald-800 font-medium whitespace-nowrap block mb-1">Waste Weight (KG):</label>
          <input type="number" id="weightInput" placeholder="Enter weight" max="10000000" class="p-3 border border-emerald-300 rounded-lg w-full focus:ring-emerald-500 focus:border-emerald-500 transition duration-200" inputmode="decimal" />
          <div id="costError" class="text-red-500 text-sm italic hidden mt-1">Please enter a valid weight.</div>
        </div>
      </div>
    </div>

    <div id="paymentSection" class="flex flex-col items-center justify-between gap-4 bg-emerald-100 rounded-xl p-6">
      <div class="flex-1 w-full">
        <div class="h-pay-button flex items-center justify-center text-center text-3xl font-bold text-emerald-800 bg-emerald-200 p-3 rounded-lg w-full">
          <span id="costDisplay">â‚¹ 0.00</span>
        </div>
      </div>
      <button id="generateQR" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center gap-2 whitespace-nowrap w-full">
        <i class="ph-bold ph-credit-card text-xl"></i>
        Pay
      </button>
    </div>

    <div id="qrContainer" class="flex flex-col items-center justify-center p-6 bg-emerald-50 rounded-lg shadow-inner border border-emerald-200 hidden">
      <div class="flex items-center justify-center gap-4 mb-4 text-emerald-700 font-semibold text-center text-sm sm:text-base">
        <span class="flex items-center gap-1"><i class="ph-bold ph-chart-line-up text-lg"></i> <span id="finalRateDisplay"></span>/KG</span>
        <span class="flex items-center gap-1"><i class="ph-bold ph-scales text-lg"></i> <span id="finalWeightDisplay"></span>KG</span>
        <span class="flex items-center gap-1"><i class="ph-bold ph-currency-inr text-lg"></i> <span id="finalCostDisplay"></span></span>
      </div>
      <div id="qrcode" class="w-full max-w-xs aspect-square border-4 border-emerald-400 p-2 rounded-lg flex items-center justify-center"></div>
      <p class="mt-4 text-center text-xs font-bold text-emerald-800">Scan to complete the payment</p>
      <div class="flex justify-center mt-4">
        <button id="resetApp" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-2 text-xs">
          <i class="ph-bold ph-arrow-counter-clockwise text-lg"></i>
          Reset
        </button>
      </div>
    </div>

    <div class="mt-8 flex flex-col items-center justify-center text-center text-xs text-gray-500">
      <p class="mb-1">Powered by AigentApps</p>
      <a href="https://www.aigentapps.com" target="_blank" rel="noopener" class="underline hover:text-gray-700 block mt-1">www.aigentapps.com</a>
    </div>

    <div id="messageBox" class="mt-4 p-4 text-center bg-emerald-100 rounded-lg text-emerald-700 border border-emerald-300 hidden"></div>
  </div>

  <script>
    // ---- Service Worker (PWA) ----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // iOS: prevent bounce/overscroll revealing URL bar when standalone
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
      document.documentElement.style.height = '100%';
      document.body.style.height = '100%';
      document.body.style.overscrollBehavior = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const rateInput = document.getElementById('rateInput');
      const weightInput = document.getElementById('weightInput');
      const costDisplay = document.getElementById('costDisplay');
      const finalCostDisplay = document.getElementById('finalCostDisplay');
      const finalWeightDisplay = document.getElementById('finalWeightDisplay');
      const finalRateDisplay = document.getElementById('finalRateDisplay');
      const generateQRBtn = document.getElementById('generateQR');
      const qrContainer = document.getElementById('qrContainer');
      const qrcodeDiv = document.getElementById('qrcode');
      const messageBox = document.getElementById('messageBox');
      const rateError = document.getElementById('rateError');
      const costError = document.getElementById('costError');
      const resetButton = document.getElementById('resetApp');
      const inputSection = document.getElementById('inputSection');
      const paymentSection = document.getElementById('paymentSection');

      const MERCHANT_ID = 'vijayavedamshibu@okaxis';
      const MERCHANT_NAME = 'ROBO-BIN';
      const DEFAULT_RATE = 7;
      const MAX_WEIGHT = 10000000;

      const showMessage = (msg, isError = false) => {
        messageBox.textContent = msg;
        messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-emerald-100', 'text-emerald-700');
        messageBox.classList.add(isError ? 'bg-red-100' : 'bg-emerald-100', isError ? 'text-red-700' : 'text-emerald-700');
      };

      const updateCost = () => {
        const rate = parseFloat(rateInput.value) || DEFAULT_RATE;
        const weight = parseFloat(weightInput.value);
        if (isNaN(weight) || weight <= 0) { costDisplay.textContent = 'â‚¹ 0.00'; return; }
        const totalCost = (weight * rate).toFixed(2);
        costDisplay.textContent = `â‚¹ ${totalCost}`;
      };

      const resetApp = () => {
        rateInput.value = '';
        weightInput.value = '';
        costDisplay.textContent = 'â‚¹ 0.00';
        finalCostDisplay.textContent = '';
        finalWeightDisplay.textContent = '';
        finalRateDisplay.textContent = '';
        qrContainer.classList.add('hidden');
        messageBox.classList.add('hidden');
        rateError.classList.add('hidden');
        costError.classList.add('hidden');
        inputSection.classList.remove('hidden');
        paymentSection.classList.remove('hidden');
        weightInput.focus();
      };

      rateInput.addEventListener('input', updateCost);
      weightInput.addEventListener('input', () => {
        const weight = parseFloat(weightInput.value);
        if (weight > MAX_WEIGHT) {
          costError.textContent = `Weight cannot exceed ${MAX_WEIGHT} kg.`;
          costError.classList.remove('hidden');
          weightInput.value = MAX_WEIGHT;
        } else {
          costError.classList.add('hidden');
        }
        updateCost();
      });
      resetButton.addEventListener('click', resetApp);

      generateQRBtn.addEventListener('click', () => {
        const rate = parseFloat(rateInput.value) || DEFAULT_RATE;
        const weight = parseFloat(weightInput.value);
        if (isNaN(rate) || rate <= 0) { rateError.classList.remove('hidden'); return; } else { rateError.classList.add('hidden'); }
        if (isNaN(weight) || weight <= 0) { costError.textContent = 'Please enter a valid weight.'; costError.classList.remove('hidden'); return; } else { costError.classList.add('hidden'); }

        const totalCost = (weight * rate).toFixed(2);
        finalCostDisplay.textContent = `${totalCost}`;
        finalWeightDisplay.textContent = weight;
        finalRateDisplay.textContent = `${rate}`;

        const upiLink = `upi://pay?pa=${encodeURIComponent(MERCHANT_ID)}&pn=${encodeURIComponent(MERCHANT_NAME)}&am=${encodeURIComponent(totalCost)}&cu=INR`;

        qrcodeDiv.innerHTML = '';
        const canvas = document.createElement('canvas');
        const size = Math.min(300, qrcodeDiv.clientWidth || 300);
        canvas.width = size; canvas.height = size;
        qrcodeDiv.appendChild(canvas);

        inputSection.classList.add('hidden');
        paymentSection.classList.add('hidden');

        try {
          QRCode.toCanvas(canvas, upiLink, { width: size, errorCorrectionLevel: 'H' }, (error) => {
            if (error) { showMessage('Error generating QR code.', true); console.error(error); }
            else { qrContainer.classList.remove('hidden'); messageBox.classList.add('hidden'); }
          });
        } catch (e) { showMessage('Error generating QR code. Library load issue?', true); console.error(e); }
      });

      // Focus for quick entry
      weightInput.focus();
    });
  </script>
</body>
</html>

<!-- ===== Manifest (manifest.webmanifest) =====
{
  "name": "ROBO-BIN Â· AigentApps",
  "short_name": "ROBO-BIN",
  "start_url": ".",
  "scope": ".",
  "display": "standalone",
  "background_color": "#f0fdf4",
  "theme_color": "#065f46",
  "orientation": "portrait-primary",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" },
    { "src": "/icons/maskable-192.png", "sizes": "192x192", "type": "image/png", "purpose": "maskable" },
    { "src": "/icons/maskable-512.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
  ]
}
-->

<!-- ===== Minimal Service Worker (sw.js) =====
self.addEventListener('install', (event) => {
  event.waitUntil(caches.open('robobin-v1').then(cache => cache.addAll([
    '/',
    '/index.html',
    '/manifest.webmanifest'
  ])));
});
self.addEventListener('fetch', (event) => {
  event.respondWith(caches.match(event.request).then(res => res || fetch(event.request)));
});
-->
